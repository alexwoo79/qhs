{{ $src := .Get "src" }}
{{ $height := .Get "height" | default "600" }}
{{ $title := .Get "title" | default "" }}
{{ $type := .Get "type" | default "bim" }}
{{ $ordinal := .Ordinal }}
{{ $isNested := .Get "nested" | default false }}

<div class="embed embed-{{ $type }} hextra-iframe" id="hextra-iframe-{{ $ordinal }}" data-nested="{{ $isNested }}">
  {{ if $title }}
    <div class="embed-title">{{ $title }}</div>
  {{ end }}

  <button 
    class="hextra-iframe-fullscreen-btn hextra-btn"
    onclick="toggleIframeFullscreen('{{ $ordinal }}')"
    title="全屏显示(按 F 键也可触发)"
    aria-label="全屏显示"
  >
    <!-- 用 CSS 伪元素替代文本，避免被摘要提取 -->
  </button>

  <div class="embed-frame" style="height: {{ $height }}px;">
    <iframe
      src="{{ $src }}"
      loading="lazy"
      frameborder="0"
      allowfullscreen
    ></iframe>
  </div>
</div>

<!-- 新增 CSS 伪元素样式 -->
<style>
.hextra-iframe-fullscreen-btn::before {
  content: "⛶全屏"; /* 图标内容 */
  display: inline-block;
}

.hextra-iframe {
  position: relative;
}
.hextra-iframe-fullscreen-btn {
  position: absolute;
  top: 0.5rem;
  right: 0.5rem;
  z-index: 10;
}
.hextra-iframe.fullscreen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  z-index: 9999;
  background: #fff;
}
.hextra-iframe.fullscreen .embed-frame {
  height: 100% !important;
}
</style>

<!-- 关键：把脚本改成立即执行，确保优先加载 -->
<script>
// 全屏切换函数，全局可访问
function toggleIframeFullscreen(ordinal) {
  const container = document.getElementById(`hextra-iframe-${ordinal}`);
  if (!container) return; // 防止找不到元素
  container.classList.toggle('fullscreen');
  document.body.style.overflow = container.classList.contains('fullscreen') ? 'hidden' : '';
}

// 页面加载完成后再监听事件，避免元素未渲染
document.addEventListener('DOMContentLoaded', function() {
  // 监听 F 键，支持所有 iframe 切换（按 F 键切换当前激活的 iframe）
  document.addEventListener('keydown', function(e) {
    // 只响应 单独按 F 键（排除 Ctrl/Shift/Alt 组合键）
    if (e.key.toLowerCase() === 'f' && !e.ctrlKey && !e.shiftKey && !e.altKey) {
      e.stopImmediatePropagation(); // 阻断其他事件监听
      e.preventDefault(); // 阻断浏览器默认行为

      // 方案1：切换 最后一个 被点击的 iframe（推荐）
      const activeIframe = document.querySelector('.hextra-iframe.active');
      if (activeIframe) {
        const ordinal = activeIframe.id.split('-')[2];
        toggleIframeFullscreen(ordinal);
        return;
      }

      // 方案2：如果没有激活的 iframe，就切换第一个
      const firstIframe = document.querySelector('.hextra-iframe');
      if (firstIframe) {
        const ordinal = firstIframe.id.split('-')[2];
        toggleIframeFullscreen(ordinal);
      }
    }
  });

  // 给每个 iframe 绑定点击事件，标记为 "激活状态"
  document.querySelectorAll('.hextra-iframe').forEach(iframe => {
    iframe.addEventListener('click', function() {
      // 移除其他 iframe 的激活状态
      document.querySelectorAll('.hextra-iframe').forEach(el => el.classList.remove('active'));
      // 标记当前 iframe 为激活
      this.classList.add('active');
    });
  });
});
</script>
