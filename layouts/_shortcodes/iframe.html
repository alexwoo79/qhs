{{- /*
Shortcode to include an iframe with fullscreen capability and nested iframe protection.

@param {string} url The URL to embed in the iframe.
@param {string} width (Optional) The width of the iframe.
@param {string} height (Optional) The height of the iframe.
@param {string} title (Optional) The title attribute for the iframe.

@example {{< iframe url="https://example.com">}}
@example {{< iframe url="https://example.com" width="100%" height="400px" title="Example Website">}}
*/ -}}

{{- $url := .Get "url" -}}
{{- $width := .Get "width" | default "100%" -}}
{{- $height := .Get "height" | default "32rem" -}}
{{- $title := .Get "title" | default "Embedded Content" -}}
{{- $ordinal := .Ordinal -}}
{{- $inDashboardList := and (in .Page.File.Dir "dashboard/") (eq .Page.Kind "section") -}}
{{- $inDashboardSingle := and (in .Page.File.Dir "dashboard/") (eq .Page.Kind "page") -}}
{{- $isNested := .Get "nested" | default false -}}

{{- if $inDashboardList -}}
  {{- $height = .Get "height" | default "500px" -}}
{{- else if $inDashboardSingle -}}
  {{- $height = .Get "height" | default "700px" -}}
{{- end -}}

<div class="hextra-iframe" id="hextra-iframe-{{ $ordinal }}" data-nested="{{ $isNested }}">
  {{ if not $inDashboardList }}
  <button class="hextra-iframe-fullscreen-btn hextra-btn" 
          onclick="toggleIframeFullscreen('{{ $ordinal }}')" 
          title="全屏显示">
    ⛶ 全屏
  </button>
  {{ end }}
  <iframe src="{{ $url | safeURL }}" width="{{ $width }}" height="{{ $height }}" frameborder="0" allowfullscreen
    title="{{ $title }}" sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
</div>

<script>
// 安全的事件处理，避免重复绑定
(function() {
  if (window.dashboardIframeInitialized) return;
  window.dashboardIframeInitialized = true;

  function toggleIframeFullscreen(ordinal) {
    const iframeContainer = document.getElementById('hextra-iframe-' + ordinal);
    if (!iframeContainer) return;

    // 检查是否在嵌套iframe中
    const isNested = window.self !== window.top;
    if (isNested && !iframeContainer.dataset.nested) {
      console.warn('Nested iframe detected, skipping fullscreen');
      return;
    }

    if (iframeContainer.classList.contains('fullscreen')) {
      // 退出全屏
      iframeContainer.classList.remove('fullscreen');
      document.body.style.overflow = '';
      
      // 通知父页面退出全屏
      if (window.parent !== window) {
        window.parent.postMessage('exitFullscreen', '*');
      }
    } else {
      // 进入全屏
      iframeContainer.classList.add('fullscreen');
      document.body.style.overflow = 'hidden';
      
      // 通知父页面进入全屏
      if (window.parent !== window) {
        window.parent.postMessage('enterFullscreen', '*');
      }
    }
  }

  // ESC 键处理
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      const fullscreenIframe = document.querySelector('.hextra-iframe.fullscreen');
      if (fullscreenIframe) {
        const ordinal = fullscreenIframe.id.replace('hextra-iframe-', '');
        toggleIframeFullscreen(ordinal);
      }
    }
  });

  // 处理父页面消息
  window.addEventListener('message', function(event) {
    if (event.data === 'enterFullscreen') {
      document.body.style.overflow = 'hidden';
    } else if (event.data === 'exitFullscreen') {
      document.body.style.overflow = '';
    }
  });

  // 检查是否在iframe中
  function inIframe() {
    try {
      return window.self !== window.top;
    } catch (e) {
      return true;
    }
  }

  // 如果在iframe中，则禁用某些功能
  if (inIframe()) {
    document.querySelectorAll('.hextra-iframe-fullscreen-btn').forEach(btn => {
      btn.style.display = 'none';
    });
  }
  
  // 全局暴露函数
  window.toggleIframeFullscreen = toggleIframeFullscreen;
})();
</script>