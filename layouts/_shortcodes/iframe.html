{{- /*
Shortcode to include an iframe with fullscreen capability.
自动拼接 baseURL，无重复斜杠，科学适配多环境
*/ -}}
{{- $url := or (.Get "url") (.Get "src") -}}
{{- $width := .Get "width" | default "100%" -}}
{{- $height := .Get "height" | default "32rem" -}}
{{- $title := .Get "title" | default "Embedded Content" -}}
{{- $ordinal := .Ordinal -}}
{{- $isNested := .Get "nested" | default false -}}

{{- /* 关键：读取全局 baseURL，并用 urls.JoinPath 处理斜杠 */ -}}
{{- $siteBaseURL := .Site.BaseURL -}}

{{- if $url -}}
  {{- if or (hasPrefix $url "http://") (hasPrefix $url "https://") (hasPrefix $url "//") -}}
    {{- /* 外部链接，直接使用 */ -}}
    {{- $url = $url | safeURL -}}
  {{- else -}}
    {{- /* 站内资源：用 urls.JoinPath 自动拼接，避免双斜杠 */ -}}
    {{- $url = urls.JoinPath $siteBaseURL $url | string | safeURL -}}
  {{- end -}}
{{- else -}}
  {{- errorf "iframe shortcode requires 'url' or 'src' parameter: %s" .Position -}}
{{- end -}}

<div class="hextra-iframe" id="hextra-iframe-{{ $ordinal }}" data-nested="{{ $isNested }}">
  <button class="hextra-iframe-fullscreen-btn hextra-btn"
          onclick="toggleIframeFullscreen('{{ $ordinal }}')"
          title="全屏显示">
    ⛶ 全屏
  </button>
  <iframe src="{{ $url }}"
          width="{{ $width }}"
          height="{{ $height }}"
          frameborder="0"
          allowfullscreen
          title="{{ $title }}"
          sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
</div>

<style>
.hextra-iframe {
  position: relative;
}
.hextra-iframe-fullscreen-btn {
  position: absolute;
  top: 0.5rem;
  right: 0.5rem;
  z-index: 10;
}
.hextra-iframe.fullscreen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  z-index: 9999;
  background: #fff;
}
</style>

<script>
function toggleIframeFullscreen(ordinal) {
  const container = document.getElementById('hextra-iframe-' + ordinal);
  if (container.classList.contains('fullscreen')) {
    container.classList.remove('fullscreen');
    document.body.style.overflow = '';
  } else {
    container.classList.add('fullscreen');
    document.body.style.overflow = 'hidden';
  }
}
</script>